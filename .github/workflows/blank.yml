name: Execute Snowflake Query on PR Merge

on:
  pull_request:
    branches:
      - main # Or your target branch
    types: [closed]

jobs:
  execute_snowflake_query:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # Specify a suitable Python version

      - name: Install Snowflake Connector
        run: pip install snowflake-connector-python

      - name: Create private key file (if using key pair)
        run: |
          echo "${{ secrets.SNOWFLAKE_PRIVATE_KEY }}" > private_key.p8
          chmod 600 private_key.p8
        if: ${{ secrets.SNOWFLAKE_PRIVATE_KEY != '' }}

      - name: Execute Snowflake query
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
          SNOWFLAKE_SCHEMA: ${{ secrets.SNOWFLAKE_SCHEMA }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_PRIVATE_KEY_PATH: private_key.p8 # Path to the created key file
          SNOWFLAKE_PRIVATE_KEY_PASSPHRASE: ${{ secrets.SNOWFLAKE_PRIVATE_KEY_PASSPHRASE }}
        run: |
          python -c "
import snowflake.connector
import os

conn = snowflake.connector.connect(
    user=os.environ['SNOWFLAKE_USER'],
    account=os.environ['SNOWFLAKE_ACCOUNT'],
    warehouse=os.environ['SNOWFLAKE_WAREHOUSE'],
    database=os.environ['SNOWFLAKE_DATABASE'],
    schema=os.environ['SNOWFLAKE_SCHEMA'],
    role=os.environ['SNOWFLAKE_ROLE'],
    private_key_path=os.environ.get('SNOWFLAKE_PRIVATE_KEY_PATH'),
    private_key_passphrase=os.environ.get('SNOWFLAKE_PRIVATE_KEY_PASSPHRASE')
)

try:
    with conn.cursor() as cursor:
        cursor.execute('INSERT INTO your_table (column1, column2) VALUES (\'value1\', \'value2\');') # Replace with your query
    print('Query executed successfully!')
finally:
    conn.close()
"
